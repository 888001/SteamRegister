# SteamRegister项目OAuth邮件功能深度分析

## 项目概述

SteamRegister是一个Steam账号自动注册工具，其中包含了完整的OAuth邮件获取功能，支持多种协议和认证方式。

## 核心功能分析

### 1. OAuth认证机制

**支持的认证方式：**
- Microsoft OAuth 2.0 (Graph API)
- IMAP OAuth 2.0
- POP3 OAuth 2.0

**认证流程：**
```python
# 1. 使用refresh_token获取access_token
def _get_access_token(self, action=0):
    data = {
        'client_id': self.email_data['client_id'],
        'refresh_token': self.email_data['refresh_token'],
        'grant_type': 'refresh_token',
    }
    if self.config['protocol'] == 'GRAPH' and action == 0:
        data['scope'] = 'https://graph.microsoft.com/.default'
    
    response = requests.post(
        'https://login.microsoftonline.com/consumers/oauth2/v2.0/token', 
        data=data
    )
```

### 2. 邮件获取方式

#### Graph API方式
```python
def _graph_get_email(self):
    headers = {
        'Authorization': f'Bearer {access_token}',
        'Content-Type': 'application/json'
    }
    params = {
        '$top': 5, 
        '$select': 'subject,body,receivedDateTime,from,hasAttachments', 
        '$orderby': 'receivedDateTime desc'
    }
    response = requests.get(
        'https://graph.microsoft.com/v1.0/me/messages', 
        headers=headers, params=params
    )
```

#### IMAP OAuth方式
```python
def _authenticate_oauth2(self):
    auth_string = f"user={email}\x01auth=Bearer {access_token}\x01\x01"
    server = imaplib.IMAP4_SSL('outlook.office365.com', 993)
    server.authenticate('XOAUTH2', lambda x: auth_string)
    return server
```

#### POP3 OAuth方式
```python
def _authenticate_oauth2(self):
    auth_string = f"user={email}\x01auth=Bearer {access_token}\x01\x01"
    auth_b64 = base64.b64encode(auth_string.encode('ascii')).decode('ascii')
    server = poplib.POP3_SSL('outlook.office365.com', 995)
    server._shortcmd('AUTH XOAUTH2')
    server._shortcmd(auth_b64)
    return server
```

### 3. 配置文件格式

**原项目支持两种格式：**

普通邮箱：
```
email----password
```

OAuth邮箱：
```
email----password----client_id----refresh_token
```

### 4. 错误处理机制

- 完整的重试逻辑
- Token自动刷新
- 详细的错误日志记录
- 多文件夹邮件搜索（INBOX, Junk, Trash, Spam等）

## 独立Demo实现

### 项目结构
```
outlook_oauth_demo/
├── config.py              # 配置管理模块
├── oauth_client.py        # OAuth认证客户端
├── email_client.py        # 邮件获取客户端
├── main.py               # 主程序和测试模块
├── oauth_setup.py        # OAuth设置助手
├── test_new_format.py    # 新格式测试
├── requirements.txt      # Python依赖
├── outlook_token.txt     # OAuth配置文件
└── README.md            # 说明文档
```

### 核心改进

1. **模块化设计**：将功能拆分为独立模块
2. **配置管理**：支持多种token格式，自动检测和转换
3. **错误处理**：完整的SSL证书处理和网络错误重试
4. **交互界面**：提供命令行和交互式两种使用方式
5. **OAuth助手**：帮助用户获取正确的refresh_token

### 关键技术点

#### 1. Token格式适配
```python
# 支持新旧两种格式
if len(parts) >= 5 and parts[2].startswith('M.C545_BAY'):
    # 旧格式: email---password---client_id---refresh_token---timestamp
    self.refresh_token = parts[3]
else:
    # 新格式: email---password---refresh_token---access_token---expires_timestamp
    self.refresh_token = parts[2]
    self.access_token = parts[3] if len(parts) > 3 else None
```

#### 2. SSL证书处理
```python
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# 在请求中添加 verify=False
response = requests.post(url, data=data, verify=False, timeout=30)
```

#### 3. Token自动刷新
```python
def update_tokens(self, new_refresh_token=None, new_access_token=None, expires_at=None):
    # 更新配置文件中的tokens
    parts = [self.email, self.password, self.refresh_token]
    if self.access_token:
        parts.append(self.access_token)
    if self.expires_at:
        parts.append(self.expires_at)
    
    new_content = '---'.join(parts)
    with open(self.token_file, 'w', encoding='utf-8') as f:
        f.write(new_content + '\n')
```

## 当前问题和解决方案

### 问题：Tenant不匹配错误
```
AADSTS7000012: The grant was obtained for a different tenant
```

**原因：**
- 当前refresh_token是为旧的client_id生成的
- 新的client_id `bb2aec70-3c74-48ab-9c37-13d36c32d99f` 属于不同的tenant

**解决方案：**
1. 使用OAuth设置助手重新获取refresh_token
2. 确保client_id和refresh_token匹配
3. 按照正确的授权流程获取新的tokens

### OAuth重新授权步骤

1. **运行OAuth设置助手**：
   ```bash
   python oauth_setup.py
   ```

2. **生成授权URL**：
   - 选择选项1生成授权URL
   - 在浏览器中打开URL
   - 登录Outlook账号并授权

3. **获取授权码**：
   - 从回调URL中提取code参数
   - 使用选项2换取tokens

4. **保存新的配置**：
   - 输入邮箱和密码
   - 自动保存到新的token文件

## 使用建议

1. **首次使用**：使用OAuth设置助手获取正确的refresh_token
2. **日常使用**：直接运行main.py进行邮件获取测试
3. **集成开发**：参考email_client.py中的API调用方式
4. **错误排查**：查看outlook_oauth.log日志文件

## 技术特点

- ✅ 完整的OAuth 2.0实现
- ✅ 支持三种邮件协议（Graph API, IMAP, POP3）
- ✅ 自动token刷新机制
- ✅ 模块化设计，易于扩展
- ✅ 完整的错误处理和日志记录
- ✅ 跨平台兼容
- ✅ 虚拟环境支持

这个demo完整展示了从原项目中提取的OAuth邮件获取功能，并进行了优化和模块化改进。
